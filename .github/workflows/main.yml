name: Football Tracker CI/CD APP

on:
  push:
    branches:
      - master
  pull_request:

permissions:
  contents: write
  pages: write
  id-token: write

defaults:
  run:
    shell: bash

jobs:
  Testing:
    uses: ./.github/workflows/Testing.yml
    secrets:
      mongodb_uri: ${{ secrets.MONGODB_URI }}

  Run_Server:
    needs: Testing
    uses: ./.github/workflows/Run_Server.yml
    secrets:
      mongodb_uri: ${{ secrets.MONGODB_URI }}

  Build:
    needs: Run_Server
    uses: ./.github/workflows/build.yml

  Deploy:
    needs: Build
    uses: ./.github/workflows/deploy.yml

  Backup:
    needs: Deploy
    uses: ./.github/workflows/backup.yml
    secrets:
      mongodb_uri: ${{ secrets.MONGODB_URI }}

  Notification:
    if: always()
    needs: Backup
    uses: ./.github/workflows/notify.yml
    secrets:
      EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
      EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
    with:
      job_summary: ${{ toJson(needs) }}
      receivers_email: "dayvidchimere@gmail.com"
      attach: "${{ needs.backup.outputs.results }}"

  Report:
    if: failure()
    uses: ./.github/workflows/report.yml
